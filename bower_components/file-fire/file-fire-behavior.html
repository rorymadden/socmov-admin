<html><head><link rel="import" href="../polymerfire/firebase.html"><script>FileFireBehavior={properties:{appName:{type:String},path:{type:String},srcUrl:{type:String,observer:"_start"},srcFile:{type:Boolean,value:!1},overWrite:{type:Boolean,value:!1},onlyImages:{type:Boolean,value:!1},resizeHeight:{type:Number},resizeWidth:{type:Number},maxScale:{type:Number,value:1},scaleStep:{type:Number,value:1},maxDimension:{type:Number,value:300},maxSize:{type:Number,value:0},progress:{type:Number,reflectToAttribute:!0,notify:!0},placeholder:{type:String,reflectToAttribute:!0,notify:!0},files:{type:Array,reflectToAttribute:!0,notify:!0},downloadUrl:{type:Array,reflectToAttribute:!0,notify:!0,value:[]},debug:{type:Boolean,value:!1}},_start:function(){this.debug&&console.debug("Starting"),this.downloadUrl=[],this._getFile().then(this._resizeIfImage.bind(this)).then(this._getPlaceholderIfImage.bind(this)).then(this._upload.bind(this)).then(this._fireUploadEvent.bind(this)).catch(console.log)},_getFile:function(){if(this.debug&&console.debug("Getting file"),null!=this.srcUrl){this.debug&&console.debug("File is remote");var a=this.srcUrl,b=this.srcUrl.split("/");return"pbs.twimg.com"==b[2]&&(a=this.srcUrl.replace("normal","400x400")),fetch(a).then(function(c){if(c.ok)return c.blob();throw Error(c.statusText)}).catch(function(){this.fire("no-remote",{message:"No file found at srcUrl"})}.bind(this))}return this.debug&&console.debug("File is local"),new Promise(function(c){c(event.target.files[0])})},_resizeIfImage:function(a){if(this.debug&&console.debug("Checking to resize"),a.type.startsWith("image")&&(null!=this.resizeWidth||null!=this.resizeHeight)){this.debug&&console.debug("Will resize");var b=this._calculateSizes();return img=new Image,img.src=URL.createObjectURL(a),new Promise(function(c){img.onload=function(){c([img.width,img.height])}}).then(function(c){return[w,h]=c,this._calculateResize(w,h)}.bind(this)).then(function(c){return[w,h]=c,this._resizeBlobToSizes([a],b,w,h)}.bind(this))}return this.debug&&console.debug("Will not resize"),[a]},_getPlaceholderIfImage:function(a){return(this.debug&&console.debug("Checking to create placeholder"),a[0].type.startsWith("image"))?(this.debug&&console.debug("Creating placeholder"),blob=a[a.length-1],new Promise(function(b){img=new Image,img.src=URL.createObjectURL(blob),b(new Promise(function(d){img.onload=function(){var f=document.createElement("canvas"),g=f.getContext("2d");f.width=img.width,f.height=img.height,g.drawImage(img,0,0,img.width,img.height),[w,h]=this._calculateResize(f.width,f.height),d(this._resizeCanvasToSize(f,Math.max(0.1*w,8),Math.max(0.1*h,8),!0))}.bind(this)}.bind(this)))}.bind(this)).then(function(b){return this.placeholder=b,{blobs:a,placeholder:b}}.bind(this))):(this.debug&&console.debug("No placeholder"),{blobs:a})},_upload:function(a){return this.debug&&console.debug("Beginning to upload"),this.debug&&console.debug(a),this._uploadNext(a.blobs,this._calculateSizes(),[]).then(function(b){return{urls:b,placeholder:a.placeholder}})},_fireUploadEvent:function(a){return this.debug&&console.debug("Firing upload event"),void this.fire("upload",a)},_calculateSizes:function(){for(var a=[0],b=this.maxScale+this.scaleStep;1!=b;)a.push(b-this.scaleStep),b-=this.scaleStep;return a},_calculateResize:function(a,b){return null==this.resizeWidth&&null!=this.resizeHeight?(newWidth=a*this.resizeHeight/b,newHeight=this.resizeHeight):null!=this.resizeWidth&&null==this.resizeHeight?(newWidth=this.resizeWidth,newHeight=b*this.resizeWidth/a):null==this.resizeWidth&&null==this.resizeHeight?(newWidth=a,newHeight=b):(newWidth=this.resizeWidth,newHeight=this.resizeHeight),[newWidth,newHeight]},_resizeBlobToSizes:function(a,b,c,d){return this.debug&&console.debug("Resize Loop"),i=a.length,i==b.length?(this.debug&&console.debug("Resize loop complete"),a):this._resizeBlob(a[i-1],b[i],c,d).then(function(e){return a.push(e),a}).then(function(e){return this._resizeBlobToSizes(e,b,c,d)}.bind(this))},_resizeBlob:function(a,b,c,d){return this.debug&&console.debug("Resizing blob"),new Promise(function(e){0==b?e(a):(newWidth=b*c,newHeight=b*d,img=new Image,img.src=URL.createObjectURL(a),e(new Promise(function(g){img.onload=function(){var k=document.createElement("canvas"),l=k.getContext("2d");k.width=img.width,k.height=img.height,l.drawImage(img,0,0,img.width,img.height),g(this._resizeCanvasToSize(k,newWidth,newHeight))}.bind(this)}.bind(this))))}.bind(this))},_resizeCanvasToSize:function(a,b,c,d){return this.debug&&console.debug("Starting canvas resize"),new Promise(function(e){for(targetSizeReached=!1;!targetSizeReached;)a.height>1.25*c&&a.width>1.25*b?a=this._resizeCanvas(a,0.8*a.width,0.8*a.width):(a=this._resizeCanvas(a,b,c),d&&(this.debug&&console.debug("Making placeholder"),e(a.toDataURL())),a.toBlob(function(g){e(g)}),targetSizeReached=!0)}.bind(this))},_resizeCanvas:function(a,b,c){this.debug&&console.debug("Resizing canvas");var d=document.createElement("canvas"),e=d.getContext("2d");return d.width=b,d.height=c,e.drawImage(a,0,0,b,c),d},_uploadNext:function(a,b,c){if(i=c.length,i<a.length){this.debug&&console.debug("Uploading next");var d=this.path;return d=d.substring(d.lastIndexOf("/")+1),d=0==i?d:d+"@"+b[i].toString()+"x",this._uploadThis(a[i],d).then(function(e){return this._uploadNext(a,b,c.concat([e]))}.bind(this))}return this.debug&&console.debug("Uploading complete"),new Promise(function(e){e(c)})},_uploadThis:function(a,b){return this.debug&&console.debug("Uploading an item"),new Promise(function(c,d){var e=firebase.storage(firebase.app(this.appName)),f=e.ref(),g=f.child(this.path.substring(0,this.path.lastIndexOf("/"))+"/"+b).put(a);g.on(firebase.storage.TaskEvent.STATE_CHANGED,function(j){switch(this.progress=100*(j.bytesTransferred/j.totalBytes),j.state){case firebase.storage.TaskState.PAUSED:break;case firebase.storage.TaskState.RUNNING:}}.bind(this),function(j){switch(j.code){case"storage/unauthorized":d("storage/unauthorized");break;case"storage/canceled":d("storage/canceled");break;case"storage/unknown":d("storage/unknown");}},function(){var j=g.snapshot.downloadURL;this.push("downloadUrl",{name:b,url:j}),c({name:b,url:j})}.bind(this))}.bind(this))}};</script></head><body></body></html>