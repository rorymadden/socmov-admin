<html><head><link rel="import" href="../bower_components/polymer/polymer-element.html"><link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html"><link rel="import" href="../bower_components/paper-dialog/paper-dialog.html"><link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html"><link rel="import" href="../bower_components/paper-fab/paper-fab.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="../bower_components/paper-item/paper-item.html"><link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html"><link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html"><link rel="import" href="../bower_components/paper-input/paper-textarea.html"><link rel="import" href="../bower_components/paper-button/paper-button.html"><link rel="import" href="../bower_components/iron-icons/iron-icons.html"><link rel="import" href="../bower_components/app-storage/app-network-status-behavior.html"><link rel="import" href="../bower_components/polymerfire/firebase-query.html"><link rel="import" href="../bower_components/polymerfire/firebase-document.html"><link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html"><link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html"><link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html"><link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html"><link rel="import" href="../bower_components/social-media-icons/social-media-icons.html"><link rel="import" href="../bower_components/file-fire/file-fire.html"><link rel="import" href="../bower_components/paper-chip/paper-chip.html"><link rel="import" href="../bower_components/paper-chip/paper-chip-input-autocomplete.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="socmov-admin-sessions"><template><style include="shared-styles iron-flex iron-flex-alignment">:host{display:block;padding:10px;}h1{margin:16px 50px 16px 0px;}paper-button{margin-top:10px;}.primaryButton{background-color:var(--paper-blue-500);color:white;}.form{padding:20px;}social-media-icons{padding:5px;}social-media-icons.inactive{color:grey;}paper-toggle-button{display:inline-block;}paper-icon-button[hidden], social-media-icons[hidden]{display:none;}.page-header{@apply --layout-horizontal;}.page-filter{padding:20px 20px 0px 0px;}.companyImage{max-height:30px;width:auto;height:auto;}#sessionDialog{width:calc(100vw - 100px);max-height:calc(100vh - 130px);margin:0;padding:0;top:100px;}</style><firebase-query id="sessionsQuery" app-name="socmov" path="{{conf}}/sessions" data="{{sessionsList}}"></firebase-query><firebase-query id="speakersQuery" app-name="socmov" path="{{conf}}/speakers/active" data="{{speakersList}}"></firebase-query><firebase-document id="sessionDoc" app-name="socmov" data="{{sessionData}}"></firebase-document><paper-dialog id="sessionDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation"><h2>Session</h2><paper-dialog-scrollable class="layout vertical form"><paper-input id="name" type="text" label="Name" required="" autofocus="" error-message="Please enter a session name" value="{{sessionData.name}}"></paper-input><paper-chip-input-autocomplete id="speakers" label="Speakers" closable="" items="{{sessionData.speakerNames}}" source="{{filteredSpeakersNames}}"></paper-chip-input-autocomplete><paper-textarea id="description" label="Description" always-float-label="" rows="3" value="{{sessionData.description}}"></paper-textarea><paper-textarea id="questions" label="Questions" always-float-label="" rows="3" value="{{sessionData.questions}}"></paper-textarea></paper-dialog-scrollable><div class="buttons"><paper-button dialog-dismiss="">Cancel</paper-button><paper-button class="primaryButton" on-tap="_create">Save</paper-button></div></paper-dialog><div class="card"><div class="page-header"><div><h1>Sessions {{activeString}}</h1></div><div><paper-button on-tap="_showCreateDialog" disabled="[[!online]]" aria-label="Add session" class="primaryButton">Create New</paper-button>(Speakers not saved on initial creation - just edit the session)</div><div class="flex"></div><div class="page-filter"><paper-toggle-button checked="{{_filterActive}}" slot="filter"></paper-toggle-button></div></div><vaadin-grid aria-label="sessions" items="[[filteredSessionsList]]" as="item" id="grid"><vaadin-grid-column><template class="header">Name</template><template>[[item.name]]</template></vaadin-grid-column><vaadin-grid-column><template class="header">Description</template><template>[[_trimText(item.description)]]</template></vaadin-grid-column><vaadin-grid-column><template class="header">Questions</template><template>[[_trimText(item.questions)]]</template></vaadin-grid-column><vaadin-grid-column><template class="header">Speakers</template><template>[[item.speakerNames]]</template></vaadin-grid-column><vaadin-grid-column width="100px"><template><div style="display: flex"><paper-icon-button icon="icons:create" on-tap="_showEditDialog" focus-target$="[[!editing]]"></paper-icon-button><paper-icon-button icon="icons:remove-circle" hidden$="[[!_filterActive]]" on-tap="_toggleActive"></paper-icon-button><paper-icon-button icon="icons:restore" hidden$="[[_filterActive]]" on-tap="_toggleActive"></paper-icon-button><paper-icon-button icon="icons:delete-forever" hidden$="[[_filterActive]]" on-tap="_showConfirmDialog"></paper-icon-button></div></template></vaadin-grid-column></vaadin-grid></div><paper-dialog id="confirmDialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation"><h2>Are you sure you want to delete the record?</h2><paper-dialog-scrollable>This is final - you can't get it back!</paper-dialog-scrollable><div class="buttons"><paper-button dialog-dismiss="">Cancel</paper-button><paper-button dialog-confirm="" autofocus="" on-tap="_delete">Accept</paper-button></div></paper-dialog></template><script>class SocmovAdminsessions extends Polymer.Element{static get is(){return'socmov-admin-sessions'}static get properties(){return{sessionsList:Array,speakersList:Array,filteredSessionsList:Array,filteredSpeakersNames:Array,filteredSpeakersNameMap:{type:Object,value:function(){return{}}},filteredSpeakersKeyMap:{type:Object,value:function(){return{}}},sessionData:{type:Object,value:function(){return{speakerNames:[]}}},_filterActive:{type:Boolean,value:!0,observer:'_filterSessionData'},activeString:String,_selectedItem:Object}}static get observers(){return['_filterSessionData(sessionsList.*)','_filterSpeakerData(speakersList.*)']}_filterSessionData(){this.filteredSessionsList=[],this.sessionsList&&this.sessionsList.forEach(function(a){'active'===a.$key&&this._filterActive?Object.keys(a).forEach(function(b){'$key'!==b&&a[b]&&(a[b].$key=b,this.push('filteredSessionsList',a[b]))}.bind(this)):'inactive'===a.$key&&!this._filterActive&&Object.keys(a).forEach(function(b){'$key'!==b&&a[b]&&(a[b].$key=b,this.push('filteredSessionsList',a[b]))}.bind(this))}.bind(this)),this.activeString=this._filterActive?'(Published)':'(UnPublished)',this._setSpeakerNames(),this.$.grid.clearCache()}_filterSpeakerData(){this.filteredSpeakersNames=this.speakersList.map(function(a){var c=a.first+' '+a.last+', '+a.company;return this.filteredSpeakersNameMap[c]=a.$key,this.filteredSpeakersKeyMap[a.$key]=c,this._setSpeakerNames(),{text:c}}.bind(this)),this.$.grid.clearCache()}_setSpeakerNames(){this.filteredSessionsList&&(this.filteredSessionsList.forEach(function(a,b){var c=this._getSpeakerNames(a.speakerKeys)||[];a.speakerNames=c,this.notifyPath('filteredSessionsList.'+b+'.speakerNames',c)}.bind(this)),this.$.grid.clearCache())}_toggleActive(a){this.sessionData=a.model.item;var b=this._filterActive?'active/':'inactive/',c=this._filterActive?'inactive/':'active/',d=Object.assign({},this.sessionData);delete d.$key,d.speakerKeys=this._getSpeakerKeys(d.speakerNames),delete d.speakerNames,this.$.sessionsQuery.ref.child(c+this.sessionData.$key).set(d).then(function(){this.$.sessionsQuery.ref.child(b+this.sessionData.$key).remove().then(function(){this._filterSessionData(),this.$.grid.clearCache()}.bind(this))}.bind(this))}_showConfirmDialog(a){this.$.confirmDialog.open(),this._selectedItem=a.model.item}_showCreateDialog(){this.sessionData={},this.$.sessionDoc.reset(),this.$.sessionDialog.open()}_showEditDialog(a){this.$.sessionDoc.data=Object.assign({},a.model.item),this.$.sessionDialog.open()}_create(){if(this.$.name.validate(),!this.$.name.invalid){var a=this._getSpeakerKeys(this.sessionData.speakerNames);if(delete this.sessionData.speakerNames,this.sessionData.speakerKeys=a,console.log(this.sessionData),!this.sessionData.$key)return this.$.sessionDoc.saveValue(this.conf+'/sessions/active').then(function(){this.$.sessionDoc.reset(),this._setSpeakerNames(),this.$.grid.clearCache(),this.$.sessionDialog.close()}.bind(this));var b=Object.assign({},this.sessionData);delete b.$key;var c=this._filterActive?'active/':'inactive/';return this.$.sessionsQuery.ref.child(c+this.sessionData.$key).set(b).then(function(){this.$.sessionDoc.reset(),this._setSpeakerNames(),this.$.grid.clearCache(),this.$.sessionDialog.close()}.bind(this))}}_delete(){return this.$.sessionsQuery.ref.child('inactive/'+this._selectedItem.$key).set(null).then(function(){this.$.sessionDoc.reset(),this._selectedItem=null,this.$.grid.clearCache()}.bind(this))}_trimText(a){var b=50;return a?a.length>b?a.substring(0,b-3)+'...':a:null}_getSpeakerKeys(a){return a&&0!==a.length?a.map(function(b){return this.filteredSpeakersNameMap[b]}.bind(this)):[]}_getSpeakerNames(a){if(!a||0===a.length)return[];var b=a.map(function(c){return this.filteredSpeakersKeyMap[c]}.bind(this));return b}_getSpeakerImage(a){var b=this.speakersList.filter(function(c){return c.$key===a})[0];return b&&b.speakerImage?b.speakerImage.placeholder:null}}window.customElements.define(SocmovAdminsessions.is,SocmovAdminsessions);</script></dom-module></body></html>